<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cup {{cup_number}} - Fantasy League</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

</head>
<body>
    <div class="cup-container">
        <div class="loading-state" id="loading">
            <div class="loading-spinner">
                <img src="{{ url_for('static', filename='loading.gif') }}" alt="Loading..." class="loading-gif">
            </div>
            <p class="loading-text">Đang tải dữ liệu...</p>
        </div>
        
        <div id="error-message" class="error-message" style="display: none;"></div>
        
        <div id="cup-content" class="cup-content" style="display: none;">
            <!-- Bảng xếp hạng -->
            <section class="standings-section">
                <div class="section-header">
                    <h2 class="section-title">Bảng Xếp Hạng Cup {{cup_number}}</h2>
                </div>
                <div class="table-responsive">
                    <table class="standings-table" id="standings-table">
                        <thead>
                            <tr>
                                <th class="col-rank">Hạng</th>
                                <th class="col-team">Tên Đội</th>
                                <th class="col-stat">Trận</th>
                                <th class="col-stat">Thắng</th>
                                <th class="col-stat">Hòa</th>
                                <th class="col-stat">Thua</th>
                                <th class="col-points">Điểm Cup</th>
                                <th class="col-diff">Hiệu Số</th>
                            </tr>
                        </thead>
                        <tbody id="standings-body">
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- Lịch đấu và kết quả -->
            <section class="schedule-section">
                <div class="section-header">
                    <h2 class="section-title">Lịch Đấu & Kết Quả</h2>
                </div>
                <div id="schedule-container" class="schedule-container">
                </div>
            </section>
        </div>
    </div>

    <script id="cup-data" type="application/json">{"cup_number": {{ cup_number }}}</script>
    
    <script>
        // Global variables
        let cupNumber = JSON.parse(document.getElementById('cup-data').textContent).cup_number;
        let cupData = null;
        
        // Load cup data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadCupData();
        });
        
        async function loadCupData() {
            try {
                const response = await fetch(`/api/cup/${cupNumber}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                cupData = data;
                
                // Hide loading and show content
                document.getElementById('loading').style.display = 'none';
                document.getElementById('cup-content').style.display = 'block';
                
                // Render cup data
                renderStandings(data.standings);
                renderSchedule(data.schedule, data.cup_info.current_week);
                
            } catch (error) {
                console.error('Error loading cup data:', error);
                showError('Không thể tải dữ liệu cup. Vui lòng thử lại sau.');
            }
        }
        

        
        function renderStandings(standings) {
            const tbody = document.getElementById('standings-body');
            tbody.innerHTML = '';
            
            standings.forEach((team, index) => {
                const row = document.createElement('tr');
                row.className = 'standings-row';
                row.innerHTML = `
                    <td class="position col-rank">${index + 1}</td>
                    <td class="team-name col-team">
                        <span class="team-name-text">${team.team_name}</span>
                    </td>
                    <td class="col-stat">${team.played}</td>
                    <td class="col-stat">${team.wins}</td>
                    <td class="col-stat">${team.draws}</td>
                    <td class="col-stat">${team.losses}</td>
                    <td class="points col-points">${team.cup_points}</td>
                    <td class="col-diff">${team.goal_difference > 0 ? '+' : ''}${team.goal_difference}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function renderSchedule(schedule, currentWeek) {
            const container = document.getElementById('schedule-container');
            container.innerHTML = '';
            
            // Filter and sort weeks: only show current week and past weeks
            const allWeeks = Object.keys(schedule).map(w => parseInt(w));
            const weeksToShow = allWeeks.filter(week => week <= currentWeek);
            const sortedWeeks = weeksToShow.sort((a, b) => b - a); // Descending order (current week first)
            
            sortedWeeks.forEach(week => {
                const weekData = schedule[week];
                const weekBlock = document.createElement('div');
                weekBlock.className = `week-block ${weekData.is_current ? 'current-week' : ''}`;
                
                let matchesHtml = '';
                weekData.matches.forEach(match => {
                    const matchResult = parseMatchResult(match);
                    matchesHtml += `
                        <div class="match-card">
                            <div class="match-teams">
                                <div class="team team-left ${matchResult.team1Class}">
                                    <span class="team-name">${match.team1}</span>
                                </div>
                                <div class="match-score-container">
                                    <div class="match-score">${matchResult.scoreText}</div>
                                </div>
                                <div class="team team-right ${matchResult.team2Class}">
                                    <span class="team-name">${match.team2}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                weekBlock.innerHTML = `
                    <div class="week-header">
                        <span class="week-title">Tuần ${week}</span>
                        ${weekData.is_current ? '<span class="current-badge">(Hiện tại)</span>' : ''}
                    </div>
                    <div class="matches-grid">
                        ${matchesHtml}
                    </div>
                `;
                
                container.appendChild(weekBlock);
            });
        }
        
        function parseMatchResult(match) {
            const result = match.result;
            
            if (!result || result === 'Chưa đấu') {
                return {
                    scoreText: 'vs',
                    team1Class: '',
                    team2Class: ''
                };
            }
            
            // Parse result format: "47-47 (Hòa)" or "50-45 (Thắng team1)" or "45-50 (Thắng team2)"
            const scoreMatch = result.match(/(\d+)-(\d+)/);
            if (!scoreMatch) {
                return {
                    scoreText: result,
                    team1Class: '',
                    team2Class: ''
                };
            }
            
            const team1Score = parseInt(scoreMatch[1]);
            const team2Score = parseInt(scoreMatch[2]);
            
            // Format score based on match result, not just score comparison
            let scoreText;
            if (result.includes('Hòa')) {
                // Draw - both scores in italic
                scoreText = `<em>${team1Score} - ${team2Score}</em>`;
            } else if (result.includes(`Thắng ${match.team1}`)) {
                // Team1 wins - team1 score bold
                scoreText = `<strong>${team1Score}</strong> - ${team2Score}`;
            } else if (result.includes(`Thắng ${match.team2}`)) {
                // Team2 wins - team2 score bold
                scoreText = `${team1Score} - <strong>${team2Score}</strong>`;
            } else {
                // Fallback to normal text
                scoreText = `${team1Score} - ${team2Score}`;
            }
            
            let team1Class = '';
            let team2Class = '';
            
            if (result.includes('Hòa')) {
                team1Class = 'team-draw';
                team2Class = 'team-draw';
            } else if (result.includes(`Thắng ${match.team1}`)) {
                team1Class = 'team-win';
                team2Class = 'team-loss';
            } else if (result.includes(`Thắng ${match.team2}`)) {
                team1Class = 'team-loss';
                team2Class = 'team-win';
            }
            
            return {
                scoreText: scoreText,
                team1Class: team1Class,
                team2Class: team2Class
            };
        }
        
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-message').style.display = 'block';
        }
    </script>
</body>
</html>
