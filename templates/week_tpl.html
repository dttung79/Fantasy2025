<main class="weekly-main">
  <div class="page-header">
    <h2 class="page-title">B·∫£ng Tu·∫ßn Tr·ª±c Ti·∫øp</h2>
    <button id="refresh-button" class="refresh-btn" onclick="refreshData()" aria-label="L√†m m·ªõi d·ªØ li·ªáu">
      <span class="refresh-icon">üîÑ</span>
      <span class="refresh-text">L√†m m·ªõi</span>
    </button>
  </div>
  <div id="toast-notification" class="toast-notification"></div>

  <div class="loading-state" id="loading" style="display: block;">
    <div class="skeleton skeleton-header"></div>
    <table class="skeleton-table">
      <thead>
        <tr>
          <th style="width: 15%;">ƒê·ªôi</th>
          <th style="width: 8%;">1</th>
          <th style="width: 8%;">2</th>
          <th style="width: 8%;">3</th>
          <th style="width: 8%;">4</th>
          <th style="width: 8%;">5</th>
          <th style="width: 8%;">6</th>
          <th style="width: 8%;">7</th>
        </tr>
      </thead>
      <tbody>
        <tr class="skeleton-row">
          <td><div class="skeleton skeleton-cell"></div></td>
          <td><div class="skeleton skeleton-cell"></div></td>
          <td><div class="skeleton skeleton-cell"></div></td>
          <td><div class="skeleton skeleton-cell"></div></td>
          <td><div class="skeleton skeleton-cell"></div></td>
          <td><div class="skeleton skeleton-cell"></div></td>
          <td><div class="skeleton skeleton-cell"></div></td>
          <td><div class="skeleton skeleton-cell"></div></td>
        </tr>
        <tr class="skeleton-row">
          <td><div class="skeleton skeleton-cell"></div></td>
          <td><div class="skeleton skeleton-cell"></div></td>
          <td><div class="skeleton skeleton-cell"></div></td>
          <td><div class="skeleton skeleton-cell"></div></td>
          <td><div class="skeleton skeleton-cell"></div></td>
          <td><div class="skeleton skeleton-cell"></div></td>
          <td><div class="skeleton skeleton-cell"></div></td>
          <td><div class="skeleton skeleton-cell"></div></td>
        </tr>
        <tr class="skeleton-row">
          <td><div class="skeleton skeleton-cell"></div></td>
          <td><div class="skeleton skeleton-cell"></div></td>
          <td><div class="skeleton skeleton-cell"></div></td>
          <td><div class="skeleton skeleton-cell"></div></td>
          <td><div class="skeleton skeleton-cell"></div></td>
          <td><div class="skeleton skeleton-cell"></div></td>
          <td><div class="skeleton skeleton-cell"></div></td>
          <td><div class="skeleton skeleton-cell"></div></td>
        </tr>
        <tr class="skeleton-row">
          <td><div class="skeleton skeleton-cell"></div></td>
          <td><div class="skeleton skeleton-cell"></div></td>
          <td><div class="skeleton skeleton-cell"></div></td>
          <td><div class="skeleton skeleton-cell"></div></td>
          <td><div class="skeleton skeleton-cell"></div></td>
          <td><div class="skeleton skeleton-cell"></div></td>
          <td><div class="skeleton skeleton-cell"></div></td>
          <td><div class="skeleton skeleton-cell"></div></td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="table-container" id="table-content" style="display: none;">
    <div class="table-controls">
      <button id="left-arrow" class="nav-arrow nav-arrow-left" onclick="shiftLeft()" aria-label="Tu·∫ßn tr∆∞·ªõc">
        <span class="arrow-icon">‚Üê</span>
        <span class="arrow-text">Tr∆∞·ªõc</span>
      </button>

      <div class="table-wrapper">
        <table id="data-table" class="weekly-table">
          <thead id="table-header"></thead>
          <tbody id="data-body"></tbody>
        </table>
      </div>

      <button id="right-arrow" class="nav-arrow nav-arrow-right" onclick="shiftRight()" aria-label="Tu·∫ßn sau">
        <span class="arrow-text">Sau</span>
        <span class="arrow-icon">‚Üí</span>
      </button>
    </div>
  </div>
</main>
<script src="{{ url_for('static', filename='fe_script.js') }}"></script>
<script>
  const leagueId = '{{ league_id }}';
  const apiUrl = `/api/week/${leagueId}`;

  // Load initial data
  loadWeekData();

  function loadWeekData() {
    fetch(apiUrl)
      .then(response => response.json())
      .then(responseData => {
        // Hide loading and show content
        document.getElementById('loading').style.display = 'none';
        document.getElementById('table-content').style.display = 'block';

        // Handle both old format (direct data array) and new format (object with data + current_week)
        if (Array.isArray(responseData)) {
          // Old format - backward compatibility
          initializeDataTable(responseData, leagueId);
        } else {
          // New format with current week info
          initializeDataTable(responseData.data, leagueId, false, responseData.current_week);
        }
      })
      .catch(error => {
        console.error('Error fetching data:', error);
        document.getElementById('loading').style.display = 'none';
        const header = document.querySelector('.page-header');
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = 'L·ªói t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i sau.';
        header.appendChild(errorDiv);
      });
  }

  function refreshData() {
    const refreshBtn = document.getElementById('refresh-button');
    const refreshIcon = refreshBtn.querySelector('.refresh-icon');

    // Disable button and show loading state
    refreshBtn.disabled = true;
    refreshIcon.classList.add('spinning');

    fetch(apiUrl)
      .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
      })
      .then(responseData => {
        // Update table with new data
        if (Array.isArray(responseData)) {
          initializeDataTable(responseData, leagueId);
        } else {
          initializeDataTable(responseData.data, leagueId, false, responseData.current_week);
        }

        // Show success toast
        showToast('ƒê√£ c·∫≠p nh·∫≠t d·ªØ li·ªáu', 'success');
      })
      .catch(error => {
        console.error('Error refreshing data:', error);
        showToast('L·ªói khi l√†m m·ªõi d·ªØ li·ªáu', 'error');
      })
      .finally(() => {
        // Re-enable button and stop spinning
        refreshBtn.disabled = false;
        refreshIcon.classList.remove('spinning');
      });
  }

  function showToast(message, type) {
    const toast = document.getElementById('toast-notification');
    toast.textContent = message;
    toast.className = `toast-notification toast-${type} toast-show`;

    setTimeout(() => {
      toast.classList.remove('toast-show');
    }, 3000);
  }
</script>